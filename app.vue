<template>
  <div class="flex">
    <div class="m-5">
      <div class="my-3 text-3xl">IP Geo Map</div>
      <div class="flex">
        <input class="input input-bordered w-full mr-2" type="text" placeholder="Google Map API key"
          v-model="apiKeyModel" />
        <button class="btn" @click="setApiKey">Set</button>
      </div>
      <Form class="w-72" @on-submit="onSubmit" />
      <div class="py-5">Fetched {{ longLatIpArr.length }} out of {{ ips.length }}, rendered
        {{ throttledLongLatIpArr.length }}</div>
    </div>
    <ClientOnly>
      <Map class="flex-grow" :markerData="throttledLongLatIpArr" />
    </ClientOnly>
  </div>
</template>

<script setup lang="ts">
const ips = ref<string[]>([]);
const longLatIpArr = ref<{ lng: number; lat: number; ip: string }[]>([]);
const throttledLongLatIpArr = ref<{ lng: number; lat: number; ip: string }[]>([]);
const ipLatLngMap = ref<{ [key: string]: { lng: number; lat: number } }>({});
const apiKeyModel = ref("");

const setApiKey = () => {
  localStorage.setItem("gMapApiKey", apiKeyModel.value);
  window.location.reload();
}

const throttle = (fn: Function, limit: number) => {
  let inThrottle: boolean;
  return function () {
    const args = arguments;
    // @ts-expect-error
    const context = this;
    if (!inThrottle) {
      fn.apply(context, args);
      inThrottle = true;
      setTimeout(() => (inThrottle = false), limit);
    }
  };
};

const throttledLongLatIpArrSetter = throttle(
  () => {
    console.log("throttle")
    throttledLongLatIpArr.value = longLatIpArr.value;

    localStorage.setItem("ips", JSON.stringify(ipLatLngMap.value));
  },
  3000
);



const getLongLat = async (ip: string) => {
  const fromStorage = ipLatLngMap.value[ip]
  if (fromStorage) {
    const { lat, lng } = fromStorage;
    return { lng: Number(lng), lat: Number(lat), ip };
  }
  try {
    const res = await fetch(`https://ipapi.co/${ip}/latlong/`);
    const [lat, lng] = await res.text().then((res) => res.split(","));
    console.log(ip, lat, lng)
    ipLatLngMap.value = { ...ipLatLngMap.value, [ip]: { lat: Number(lat), lng: Number(lng) } };
    return { lng: Number(lng), lat: Number(lat), ip };
  } catch (e) {
    console.error(e);
    return { lng: 0, lat: 0, ip };
  }
};

const onSubmit = async (ipArr: string[]) => {
  console.log(ipArr);
  ips.value = ipArr;
  longLatIpArr.value = [];
  throttledLongLatIpArr.value = [];
  // longLatIpArr.value = await Promise.all(ipArr.map(getLongLat));
  for (const ip of ipArr) {
    const longLat = await getLongLat(ip);
    longLatIpArr.value = [...longLatIpArr.value, longLat];
    throttledLongLatIpArrSetter();
  }
  throttledLongLatIpArr.value = longLatIpArr.value;
};

onMounted(() => {
  const ipsFromLocalStorage = localStorage.getItem("ips");
  if (ipsFromLocalStorage) {
    ipLatLngMap.value = JSON.parse(ipsFromLocalStorage);
  }
  apiKeyModel.value = localStorage.getItem("gMapApiKey") || "";
});
</script>
